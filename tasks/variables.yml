---
# Load variables and set facts required for role execution

- name: Load OS specific variables
  include_vars:
    file: "{{ item }}"
    name: ofed_os
  with_first_found:
    # Try the exact distribution name first (with spaces removed).  Do not
    # lowercase the name so that file names such as `RedHat.yml` and
    # `Proxmox.yml` match correctly.  If no distribution‑specific file
    # exists fall back to an OS family file and then to default.yml.
    - "{{ ansible_distribution | regex_replace('^([^ ]+) .*', '\\1') }}.yml"
    - "{{ ansible_os_family }}.yml"
    - "default.yml"

- name: Set OFED repository distribution string
  set_fact:
    ofed_repo_dist_name: >-
      {% if ofed_target_release|length > 0 %}
        {{ ofed_target_release }}
      {% else %}
        {{ ansible_distribution | lower }}{{ ansible_distribution_version }}
      {% endif %}
  when: ofed_repo_dist_name is not defined

- name: Set OFED repository file name and URL
  set_fact:
    ofed_repo_file_name: "mellanox_mlnx_ofed.{{ ofed_os.ofed_repo_file_extension }}"
    ofed_repo_url: "{{ ofed_repository_url }}/{{ ofed_version }}/{{ ofed_repo_dist_name }}/{{ ofed_repo_file_name }}"

# When using the APT package manager set variables for the keyring
# directory and Mellanox GPG key location.  These variables are used
# by the Debian/Ubuntu/Proxmox installation tasks to download the key
# into the `/etc/apt/keyrings` directory and reference it via the
# `signed-by` mechanism.  Only set these variables on systems where
# the package manager is apt; on Red Hat systems they are unused.
- name: Set APT keyring variables
  set_fact:
    ofed_apt_keyrings_dir: "/etc/apt/keyrings"
    ofed_apt_key_filename: "mellanox_ofed.asc"
    ofed_apt_key_dest: "{{ ofed_apt_keyrings_dir }}/{{ ofed_apt_key_filename }}"
  when: ansible_pkg_mgr == 'apt'

# Choose sensible default IOMMU kernel parameters based on CPU vendor.  If
# ``ofed_sriov_iommu_options`` is already defined by the caller then
# preserve it verbatim.  Otherwise inspect the ``ansible_processor`` fact
# to determine whether the system contains an AMD or Intel CPU and
# assign appropriate defaults.  On AMD systems ``amd_iommu=on iommu=pt``
# is commonly used; on Intel systems ``intel_iommu=on iommu=pt pci=realloc``
# provides good performance.
- name: Determine default SR‑IOV IOMMU options
  set_fact:
    ofed_sriov_iommu_options_resolved: >-
      {% if ofed_sriov_iommu_options is defined and (ofed_sriov_iommu_options | string | length > 0) %}
        {{ ofed_sriov_iommu_options }}
      {% else %}
        {% set cpu = (ansible_processor | default([])) | join(' ') | lower %}
        {% if 'amd' in cpu %}
          amd_iommu=on iommu=pt
        {% else %}
          intel_iommu=on iommu=pt pci=realloc
        {% endif %}
      {% endif %}
